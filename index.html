<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Learning Hub</title>
    <meta name="theme-color" content="#f0f8ff">
    <link rel="manifest" href="manifest.json">   
    <link rel="icon" type="image/png" sizes="192x192" href="images/android-chrome-192x192.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/konva@10/konva.min.js"></script>
</head>
<body>

    <h1 id="logo-header" style="cursor: pointer;">
        <img src="images/logo.png" alt="Kids Learning Hub Logo" class="title-logo"> 
        Kids Learning Hub
    </h1>

    <div class="menu-container">
        <button id="open-sticker-book" class="menu-btn" style="background-color: #ffffff; color: #333; border: 4px solid #FFD700; margin-bottom: 5px;">
            ‚≠ê My Sticker Book
        </button>

        <div id="sticker-overlay" class="hidden" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
            <div style="background:#fff; width:95%; max-width:900px; height:90%; border-radius:20px; padding:20px; overflow-y:auto; display:flex; flex-direction:column; align-items:center; position: relative;">
                
                <div style="width:100%; display:flex; justify-content:space-between; align-items: center;">
                    <button id="toggle-play-mode" style="background:#2196F3; color:white; border:none; padding: 8px 15px; border-radius:20px; cursor:pointer; font-family: 'Comic Neue'; font-weight: bold;">
                        üé® Play Mode
                    </button>
                    <button id="close-sticker-book" style="background:#f44336; color:white; border:none; font-size:1.5em; width:40px; height:40px; border-radius:50%; cursor:pointer;">&times;</button>
                </div>

                <h1 style="margin-top:10px; font-size: 2.5em;">My Stickers</h1>
                
                <div id="sticker-progress-container">
                    <div id="sticker-progress-bar">0%</div>
                </div>

                <div id="sticker-grid" style="display:flex; flex-wrap:wrap; gap:15px; justify-content:center; padding:10px; width: 100%;"></div>

                <div id="sticker-canvas-container">
                    <div id="play-canvas"></div>
                    <p style="position:absolute; bottom:5px; width:100%; text-align:center; color:#555; font-size:0.9em; pointer-events:none; font-weight:bold; background:rgba(255,255,255,0.5);">
                        Tap stickers in the grid to add them!
                    </p>
                </div>

                <div style="margin-top: auto; padding-top: 20px;">
                    <button id="reset-stickers-btn" style="background:none; border:none; color:#999; text-decoration:underline; cursor:pointer; font-size: 0.9em;">Reset Progress</button>
                </div>
            </div>
        </div>

        <a href="./VideoTime/index.html" class="video-link-btn" title="Video Time!">
            <i class="fas fa-play-circle"></i>
        </a>
        <a href="Alphabet/index.html" class="menu-btn" id="alphabet-btn">Alphabet Fun</a>
        <a href="Number/index.html" class="menu-btn" id="number-btn">Numbers Fun</a>
        <a href="Coloring/index.html" class="menu-btn" id="coloring-btn">Coloring Book</a>
        <a href="Spelling/index.html" class="menu-btn" id="spelling-btn">Let's Spell</a>
        <a href="ShapesAndColors/index.html" class="menu-btn" id="shapes-colors-btn">Shapes & Colors</a>
    </div>

    <script src="Helper-Scripts/speech-module.js"></script>
    <script src="Helper-Scripts/sticker-module.js"></script>

    <script>
        // --- 1. INITIALIZATION & EASTER EGGS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Speech Warmup
            let speechApiWarmedUp = false;
            function warmUpSpeechAPI() {
                if (speechApiWarmedUp || !window.speechSynthesis) return;
                const utterance = new SpeechSynthesisUtterance("");
                utterance.volume = 0;
                window.speechSynthesis.speak(utterance);
                window.speechSynthesis.getVoices();
                speechApiWarmedUp = true;
            }
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.addEventListener('mousedown', warmUpSpeechAPI);
            });

            // EASTER EGG 1: THE CLICKER (TEST MODE: Click logo 3 times)
            let logoClicks = 0;
            document.getElementById('logo-header').addEventListener('click', () => {
                logoClicks++;
                // --- CHANGED: Now awards after 3 clicks (instead of 10) ---
                if(logoClicks === 3) {
                    window.StickerManager.awardSticker('clicker_owl');
                }
            });

            // EASTER EGG 2: NIGHT OWL (TEST MODE: Always awards)
            // --- CHANGED: Removed time check for immediate testing ---
            setTimeout(() => {
                window.StickerManager.awardSticker('night_owl');
            }, 1000);
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW fail', err));
            });
        }

        // --- 2. STICKER BOOK LOGIC ---
        const stickerOverlay = document.getElementById('sticker-overlay');
        const stickerGrid = document.getElementById('sticker-grid');
        const contentContainer = stickerOverlay.children[0];
        let playModeStage = null;
        let playModeLayer = null;

        document.getElementById('open-sticker-book').addEventListener('click', () => {
            stickerOverlay.style.display = 'flex';
            renderStickers();
        });

        document.getElementById('close-sticker-book').addEventListener('click', () => {
            stickerOverlay.style.display = 'none';
        });

        // Reset Logic
        document.getElementById('reset-stickers-btn').addEventListener('click', () => {
            if(confirm("Are you sure you want to delete all stickers and start over?")) {
                localStorage.removeItem('klh_sticker_inventory');
                if(playModeLayer) playModeLayer.destroyChildren(); 
                if(playModeStage) playModeStage.draw();
                renderStickers();
            }
        });

        // Toggle Play Mode
        document.getElementById('toggle-play-mode').addEventListener('click', () => {
            contentContainer.classList.toggle('play-mode-active');
            const isPlayMode = contentContainer.classList.contains('play-mode-active');
            document.getElementById('toggle-play-mode').textContent = isPlayMode ? "Back to Grid" : "üé® Play Mode";
            
            if (isPlayMode) {
                initPlayMode();
            }
        });

        function renderStickers() {
            stickerGrid.innerHTML = '';
            if (!window.StickerManager) return;

            const allStickers = window.StickerManager.getStickerData();
            const myStickers = window.StickerManager.getInventory();
            
            // Update Progress Bar
            const total = Object.keys(allStickers).length;
            const earned = myStickers.length;
            const pct = Math.round((earned / total) * 100);
            const bar = document.getElementById('sticker-progress-bar');
            bar.style.width = `${pct}%`;
            bar.textContent = `${earned} / ${total} Found`;

            // Render Grid
            for (const [key, data] of Object.entries(allStickers)) {
                const isOwned = myStickers.includes(key);
                const slot = document.createElement('div');
                const iconClass = isOwned ? '' : 'sticker-locked';

                slot.className = 'sticker-slot';
                slot.style.cssText = `
                    width: 100px; height: 120px; display:flex; flex-direction:column;
                    align-items:center; justify-content:center; border-radius:15px;
                    background: ${isOwned ? '#fff' : '#f0f0f0'};
                    border: 3px solid ${isOwned ? data.color : '#ccc'};
                    box-shadow: ${isOwned ? '0 4px 6px rgba(0,0,0,0.1)' : 'none'};
                `;

                slot.innerHTML = `
                    <div class="${iconClass}" style="font-size: 50px; transition: transform 0.2s;">
                        ${data.icon}
                    </div>
                    <span style="
                        font-family:'Comic Neue'; 
                        font-weight:bold; 
                        margin-top:2px; 
                        font-size:0.6em; 
                        color:#333; 
                        text-align:center; 
                        line-height:1.1; 
                        width: 100%;
                        padding: 0 2px;
                        box-sizing: border-box;
                    ">
                        ${isOwned ? data.name : '???'}
                    </span>
                `;

                // Click to Speak & Add to Canvas
                if (isOwned) {
                    slot.addEventListener('click', () => {
                        // Bounce Animation
                        slot.classList.add('bounce');
                        setTimeout(() => slot.classList.remove('bounce'), 500);
                        
                        // Speech
                        if (window.speakText) window.speakText(data.speech || data.name);

                        // If in play mode, add to canvas
                        if (contentContainer.classList.contains('play-mode-active')) {
                            addToCanvas(data.icon);
                        }
                    });
                }

                stickerGrid.appendChild(slot);
            }
        }

        // --- 3. KONVA PLAY MODE ---
        function initPlayMode() {
            const container = document.getElementById('sticker-canvas-container');
            
            if (!playModeStage) {
                playModeStage = new Konva.Stage({
                    container: 'play-canvas',
                    width: container.clientWidth,
                    height: container.clientHeight
                });
                
                // 1. Background Layer (Scenery)
                const bgLayer = new Konva.Layer();
                playModeStage.add(bgLayer);
                
                // Sky
                const sky = new Konva.Rect({
                    width: playModeStage.width(),
                    height: playModeStage.height(),
                    fill: '#E3F2FD' // Light Blue
                });
                bgLayer.add(sky);
                
                // Ground
                const groundHeight = 150; // Taller ground
                const ground = new Konva.Rect({
                    x: 0,
                    y: playModeStage.height() - groundHeight,
                    width: playModeStage.width(),
                    height: groundHeight,
                    fill: '#C8E6C9' // Light Green
                });
                bgLayer.add(ground);

                // Sun
                const sun = new Konva.Circle({
                    x: playModeStage.width() - 80,
                    y: 80,
                    radius: 50,
                    fill: '#FFF59D',
                    shadowBlur: 20,
                    shadowColor: '#FFD54F',
                    opacity: 0.9
                });
                bgLayer.add(sun);

                // --- SILHOUETTES (SCENERY) ---
                
                // 1. House
                Konva.Image.fromURL('ShapesAndColors/images/puzzle-house.png', function(houseNode) {
                    const h = 180; 
                    const w = h * (houseNode.width() / houseNode.height()); 
                    houseNode.setAttrs({
                        x: 40,
                        y: playModeStage.height() - groundHeight - h + 20, // Sits on ground
                        width: w,
                        height: h,
                        opacity: 0.7, // Semi-transparent silhouette
                    });
                    bgLayer.add(houseNode);
                });

                // 2. Train (Added as per plan)
                Konva.Image.fromURL('ShapesAndColors/images/puzzle-train.png', function(trainNode) {
                    const h = 120; 
                    const w = h * (trainNode.width() / trainNode.height()); 
                    trainNode.setAttrs({
                        x: playModeStage.width() - w - 40,
                        y: playModeStage.height() - groundHeight - h + 20,
                        width: w,
                        height: h,
                        opacity: 0.7,
                    });
                    bgLayer.add(trainNode);
                });


                // 2. Sticker Layer (Draggable Items)
                playModeLayer = new Konva.Layer();
                playModeStage.add(playModeLayer);
                
                // Resize listener to keep background covering full area
                new ResizeObserver(() => {
                     if(!playModeStage) return;
                     const w = container.clientWidth;
                     const h = container.clientHeight;
                     playModeStage.width(w);
                     playModeStage.height(h);
                     sky.width(w); sky.height(h);
                     ground.y(h - groundHeight); ground.width(w);
                     sun.x(w - 80);
                }).observe(container);
            }
        }

        function addToCanvas(iconChar) {
            if (!playModeStage) return;
            // Add random position in the "sky" area mostly
            const x = playModeStage.width() / 2 + (Math.random() * 100 - 50);
            const y = playModeStage.height() / 3 + (Math.random() * 60 - 30);
            addKonvaSticker(iconChar, x, y);
        }

        function addKonvaSticker(iconChar, x, y) {
            const textNode = new Konva.Text({
                x: x,
                y: y,
                text: iconChar,
                fontSize: 70, // Bigger stickers
                draggable: true,
                shadowColor: 'black',
                shadowBlur: 2,
                shadowOpacity: 0.2,
                shadowOffset: {x : 2, y : 2}
            });

            textNode.on('mouseover', function () {
                document.body.style.cursor = 'pointer';
                this.scale({x: 1.1, y: 1.1});
                playModeLayer.batchDraw();
            });
            textNode.on('mouseout', function () {
                document.body.style.cursor = 'default';
                this.scale({x: 1, y: 1});
                playModeLayer.batchDraw();
            });
            textNode.on('click tap', function() {
                 this.moveToTop();
            });
            
            // Double tap to remove
            textNode.on('dblclick dbltap', function() {
                this.destroy();
                playModeLayer.batchDraw();
            });

            playModeLayer.add(textNode);
            playModeLayer.batchDraw();
        }

    </script>
</body>
</html>